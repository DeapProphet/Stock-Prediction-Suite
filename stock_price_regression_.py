# -*- coding: utf-8 -*-
"""Stock_Price_Regression .ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fE8z90A7qVFAPqknJY5h7buzuRIaiV14
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import io
from google.colab import files
from sklearn.preprocessing import PolynomialFeatures
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error

# ---------------------------------------------------------
# 1. UPLOAD
# ---------------------------------------------------------
print("Upload your 6 bank files...")
uploaded = files.upload()
filenames = list(uploaded.keys())

if not filenames:
    raise ValueError("No files uploaded.")

# ---------------------------------------------------------
# 2. CONFIGURATION
# ---------------------------------------------------------
# Degree 4 allows the line to curve enough to capture a bull/bear cycle
# without going completely crazy.
POLY_DEGREE = 4

rows = len(filenames)
fig, axes = plt.subplots(rows, 1, figsize=(12, 6 * rows))
if rows == 1: axes = [axes]

print(f"\nTraining Polynomial Regression (Degree {POLY_DEGREE}) on {rows} datasets...")

# ---------------------------------------------------------
# 3. MAIN LOOP
# ---------------------------------------------------------
for i, filename in enumerate(filenames):
    print(f"\nProcessing {filename}...")

    # --- A. LOAD & CLEAN ---
    try:
        df = pd.read_csv(io.BytesIO(uploaded[filename]))
    except:
        print(f"Failed to read {filename}")
        continue

    # Robust Column Finder
    possible_cols = ['Adj Close ', 'Adj_Close', 'Close', 'Price']
    target_col = next((c for c in possible_cols if c in df.columns), None)

    if not target_col:
        print(f"Skipping {filename}: No price column found.")
        continue

    # Sort and Clean
    if 'Date' in df.columns:
        df['Date'] = pd.to_datetime(df['Date'])
        df = df.sort_values('Date').reset_index(drop=True)

    df = df.dropna(subset=[target_col])

    # --- B. PREPARE DATA (X=Time, y=Price) ---
    # We use the integer index as "Time"
    X = np.arange(len(df)).reshape(-1, 1)
    y = df[target_col].values

    # --- C. SPLIT (Chronological) ---
    # 80% Train, 20% Test
    split_idx = int(len(df) * 0.8)

    X_train = X[:split_idx]
    y_train = y[:split_idx]

    X_test = X[split_idx:]
    y_test = y[split_idx:]

    # --- D. TRANSFORM & TRAIN ---
    # 1. Create Polynomial Features (t, t^2, t^3...)
    poly = PolynomialFeatures(degree=POLY_DEGREE)
    X_train_poly = poly.fit_transform(X_train)
    X_test_poly = poly.transform(X_test)

    # 2. Fit Linear Regression to the Polynomial Features
    model = LinearRegression()
    model.fit(X_train_poly, y_train)

    # --- E. PREDICT ---
    # We predict on the test set to see how well the trend holds
    y_pred = model.predict(X_test_poly)

    # --- F. EVALUATE (MSE) ---
    mse = mean_squared_error(y_test, y_pred)

    # --- G. PLOTTING ---
    ax = axes[i]

    # Plot 1: Training Data (History)
    ax.plot(X_train, y_train, color='gray', alpha=0.4, label='Training Data')

    # Plot 2: Actual Test Data (The "Truth")
    ax.plot(X_test, y_test, color='blue', linewidth=2, label='Actual Price')

    # Plot 3: Polynomial Prediction (The Trend)
    ax.plot(X_test, y_pred, color='red', linewidth=2, linestyle='--', label=f'Poly Degree {POLY_DEGREE}')

    # Styling
    ax.set_title(f"{filename} | Polynomial Regression | MSE: {mse:.2f}")
    ax.set_ylabel(f"Price ({target_col})")
    ax.legend(loc='upper left')
    ax.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()